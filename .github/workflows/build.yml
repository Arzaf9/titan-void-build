name: Titanium Forge v38.0 (Legit User Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_cache
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_cache
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/4] ROOT: SYSTEM PREP"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –°—Ç–∞–≤–∏–º bash, sudo –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Root)
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel sudo shadow

            # –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ builder
            if ! id -u builder >/dev/null 2>&1; then
              useradd -m -s /bin/bash builder
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            fi

            # –í–ê–ñ–ù–û: –û—Ç–¥–∞–µ–º –ø–∞–ø–∫—É —é–∑–µ—Ä—É, –∏–Ω–∞—á–µ git –∏ xbps —Å–ª–æ–º–∞—é—Ç—Å—è
            chown -R builder:builder /void-packages

            # –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú–°–Ø –ù–ê –Æ–ó–ï–†–ê –ò –†–ê–ë–û–¢–ê–ï–ú
            su builder -c "bash << \"USER_EOF\"
            set -e
            cd /void-packages

            echo \">>> [2/4] USER: REPO SYNC\"
            if [ ! -d \".git\" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git config --global --add safe.directory /void-packages
              git fetch origin && git reset --hard origin/master
            fi

            echo \">>> [3/4] USER: CONFIGURING HASWELL\"
            # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
            rm -f etc/conf
            
            # –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫–∞—á–∫—É –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤ (–¢–û–õ–¨–ö–û –°–ë–û–†–ö–ê)
            echo \"XBPS_SKIP_REMOTEREPOS=yes\" >> etc/conf
            echo \"XBPS_ALLOW_RESTRICTED=yes\" >> etc/conf
            echo \"XBPS_MAKEJOBS=\$(nproc)\" >> etc/conf
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS=\\\"-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe\\\"
            echo \"XBPS_CFLAGS=\$FLAGS\" >> etc/conf
            echo \"XBPS_CXXFLAGS=\$FLAGS\" >> etc/conf
            echo \"XBPS_LDFLAGS=\\\"-Wl,-O1 -Wl,--as-needed -flto=auto\\\"\" >> etc/conf

            echo \"--> BOOTSTRAP (Downloading tools)...\"
            # –≠—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å sudo
            ./xbps-src binary-bootstrap

            echo \"--> FORGING PIXMAN (COMPILING)...\"
            # –ó–∞–ø—É—Å–∫ –æ–±—ã—á–Ω–æ–π —Å–±–æ—Ä–∫–∏
            ./xbps-src pkg pixman
            USER_EOF"

            echo ">>> [4/4] ROOT: EXPORTING ARTIFACTS"
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ Root –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            find /void-packages/hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ GitHub (UID 1001)
            chown -R 1001:1001 /void-packages /var/cache/xbps
            chmod -R 777 /artifacts
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-userbuild
          path: artifacts/
