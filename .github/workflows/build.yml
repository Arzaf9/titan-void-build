name: Titanium Forge v19.0 (Cache & Persistence)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Cleanup
        run: |
          # –ß–∏—Å—Ç–∏–º –º–µ—Å—Ç–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          sudo rm -rf artifacts
          mkdir -p artifacts void-packages

      - name: 2. Persistent Cache for Void-Packages
        uses: actions/cache@v4
        with:
          path: void-packages
          # –ö—ç—à –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ö–µ—à—É, –Ω–æ –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –≤—Å–µ–≥–¥–∞
          key: titanium-void-cache-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            titanium-void-cache-${{ runner.os }}-
            titanium-void-cache-

      - name: 3. Create Build Script
        run: |
          cat << 'EOF' > run_build.sh
          #!/bin/bash
          set -e

          echo ">>> [1/5] REPO SETUP..."
          mkdir -p /etc/xbps.d
          echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
          
          # –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑—ã
          xbps-install -Sy || true
          xbps-install -y xbps ca-certificates
          xbps-install -Syu -y bash sudo git curl tar base-devel shadow

          # –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ –µ—Å–ª–∏ –Ω–µ—Ç
          if ! id -u builder >/dev/null 2>&1; then
            useradd -m -s /bin/bash builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          fi

          # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–∞–ø–∫–∞ –ø—É—Å—Ç–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à)
          if [ ! -d "/home/builder/void-packages/.git" ]; then
            echo "--> Cache empty, cloning..."
            sudo -u builder git clone --depth 1 https://github.com/void-linux/void-packages.git /home/builder/void-packages
          else
            echo "--> Using cached void-packages"
            cd /home/builder/void-packages && sudo -u builder git pull
          fi

          echo ">>> [2/5] FIXING ETHEREAL ENVIRONMENT..."
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑—É —Å–±–æ—Ä–∫–∏ –ø—Ä—è–º–æ –≤ –î–æ–∫–µ—Ä
          xbps-install -y base-chroot
          # –ú–µ—Ç–∫–∞ –¥–ª—è xbps-src, —á—Ç–æ —ç—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –∏ –µ—Å—Ç—å –º–∞—Å—Ç–µ—Ä-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
          touch /.xbps_chroot_init

          echo ">>> [3/5] STARTING COMPILATION AS BUILDER..."
          sudo -u builder -i bash << 'USER_EOF'
          set -e
          cd ~/void-packages

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ (–ú–∞—Å—Ç–µ—Ä–¥–∏—Ä = –ö–æ—Ä–µ–Ω—å)
          echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
          echo "XBPS_MASTERDIR=/" >> etc/conf
          echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf

          # üíé 13 TITANIUM FLAGS
          FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
          echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
          echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
          echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

          echo "   -> FORGING PIXMAN..."
          # -E (ethereal) + -f (force)
          ./xbps-src -E -f pkg pixman
          USER_EOF

          echo ">>> [4/5] EXPORTING..."
          cp -r /home/builder/void-packages/hostdir/binpkgs/* /artifacts/ 2>/dev/null || echo "No packages found"
          EOF
          chmod +x run_build.sh

      - name: 4. Run Docker
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/run_build.sh:/run_build.sh \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/void-packages:/home/builder/void-packages \
            voidlinux/voidlinux-musl /bin/sh /run_build.sh

      - name: 5. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-haswell-packages
          path: artifacts/
