name: Titanium Forge v39.0 (Scripted User Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_cache
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_cache
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/4] ROOT: SETUP SYSTEM"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –°—Ç–∞–≤–∏–º –±–∞–∑—É
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel sudo shadow

            # –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞
            if ! id -u builder >/dev/null 2>&1; then
              useradd -m -s /bin/bash builder
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            fi

            # –û—Ç–¥–∞–µ–º –ø–∞–ø–∫—É —é–∑–µ—Ä—É
            chown -R builder:builder /void-packages

            # --- –ì–ï–ù–ï–†–ò–†–£–ï–ú –°–ö–†–ò–ü–¢ –î–õ–Ø –Æ–ó–ï–†–ê (–ß–¢–û–ë–´ –ù–ï –ë–´–õ–û –û–®–ò–ë–û–ö –°–ò–ù–¢–ê–ö–°–ò–°–ê) ---
            cat << "EOF_USER" > /home/builder/build_task.sh
            #!/bin/bash
            set -e
            cd /void-packages

            echo ">>> [2/4] USER: REPO SYNC"
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git config --global --add safe.directory /void-packages
              git fetch origin && git reset --hard origin/master
            fi

            echo ">>> [3/4] USER: CONFIGURATION"
            # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä–æ–µ
            rm -rf etc/conf hostdir/binpkgs/*

            # –ö–æ–Ω—Ñ–∏–≥
            echo "XBPS_SKIP_REMOTEREPOS=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=\$(nproc)" >> etc/conf
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            echo "--> BOOTSTRAP (Downloading tools)..."
            ./xbps-src binary-bootstrap

            echo "--> FORGING PIXMAN (COMPILING)..."
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –æ—Ç —é–∑–µ—Ä–∞
            ./xbps-src pkg pixman
            EOF_USER

            # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
            chmod +x /home/builder/build_task.sh
            chown builder:builder /home/builder/build_task.sh

            echo ">>> [EXEC] RUNNING BUILD TASK AS BUILDER"
            su builder -c "/bin/bash /home/builder/build_task.sh"

            echo ">>> [4/4] ROOT: EXPORTING"
            find /void-packages/hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∞–≤ –¥–ª—è –∫—ç—à–∞
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages /var/cache/xbps
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-user
          path: artifacts/
