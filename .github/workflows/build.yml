name: Void Forge (Root Bypass Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: voidlinux/voidlinux-musl:latest
      options: --privileged

    steps:
      - name: 1. Fix Repos & Install Tools
        run: |
          # Чистим зеркала и ставим основное
          rm -rf /etc/xbps.d/*
          echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
          
          # Игнорим SSL и обновляемся
          export SSL_NO_VERIFY=1
          xbps-install -Syu -y xbps || xbps-install -S -y xbps
          xbps-install -Syu -y ca-certificates git bash curl tar base-devel sudo

      - name: 2. Clone & Bypass Root Check
        run: |
          git clone --depth=1 https://github.com/void-linux/void-packages.git /void-packages
          cd /void-packages
          
          # ХАК: Удаляем проверку на root в самом скрипте xbps-src
          sed -i 's/id -u) -eq 0/1 -eq 2/' xbps-src
          
          # Настройка конфига
          echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          
          # Твои Haswell флаги
          FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto"
          echo "XBPS_CFLAGS='$FLAGS'" >> etc/conf
          echo "XBPS_CXXFLAGS='$FLAGS'" >> etc/conf

      - name: 3. Forge Package
        run: |
          cd /void-packages
          export SSL_NO_VERIFY=1
          # Теперь он не будет ругаться на рута из-за sed-хака
          ./xbps-src pkg pixman

      - name: 4. Export Result
        if: always()
        run: |
          mkdir -p /artifacts
          if [ -d "/void-packages/hostdir/binpkgs" ]; then
            find /void-packages/hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
          fi

      - name: 5. Upload
        uses: actions/upload-artifact@v4
        with:
          name: pixman-optimized
          path: /artifacts/
