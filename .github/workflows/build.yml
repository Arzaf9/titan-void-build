name: Titanium Forge v13.0 (Clean User Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Artifacts Dir
        run: mkdir -p artifacts

      - name: 2. THE BUILD (Docker Wrapper)
        run: |
          # Запускаем контейнер. Монтируем папку для вывода файлов.
          docker run --privileged --rm \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            
            # === [ ROOT BLOCK ] ===
            # Здесь мы готовим систему и создаем юзера
            
            echo "--> [ROOT] Fixing Mirrors..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            echo "--> [ROOT] Installing Base Tools..."
            # Обновляем ключи
            xbps-install -S -y || true
            xbps-install -y xbps ca-certificates
            # Ставим bash, sudo и инструменты сборки
            xbps-install -Syu -y bash sudo git curl tar base-devel
            
            echo "--> [ROOT] Creating User builder..."
            useradd -m -s /bin/bash builder
            # Даем ему sudo без пароля (нужно для xbps-src)
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            
            # Создаем рабочую папку и отдаем её юзеру
            mkdir /void-packages
            chown builder:builder /void-packages
            
            # === [ USER BLOCK ] ===
            # Переключаемся на билдера и делаем грязную работу
            
            su builder -c "
                set -e
                echo \"--> [USER] Cloning Repository...\"
                cd /void-packages
                git clone --depth 1 https://github.com/void-linux/void-packages.git .
                
                echo \"--> [USER] Bootstrap...\"
                ./xbps-src binary-bootstrap
                
                echo \"--> [USER] Configuring Haswell...\"
                # Твои 13 флагов
                FLAGS=\"-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe\"
                
                echo \"XBPS_CFLAGS='\$FLAGS'\" > etc/conf
                echo \"XBPS_CXXFLAGS='\$FLAGS'\" >> etc/conf
                echo \"XBPS_LDFLAGS='-Wl,-O1 -Wl,--as-needed -flto=auto'\" >> etc/conf
                echo \"XBPS_ALLOW_RESTRICTED=yes\" >> etc/conf
                echo \"XBPS_MAKEJOBS=\$(nproc)\" >> etc/conf
                # Ethereal обязателен в Докере
                echo \"XBPS_CHROOT_CMD=ethereal\" >> etc/conf
                
                echo \"--> [USER] Building PIXMAN...\"
                # Запуск сборки
                ./xbps-src -E pkg pixman
            "
            
            # === [ EXPORT BLOCK ] ===
            echo "--> [ROOT] Exporting artifacts..."
            # Копируем результаты наружу
            if [ -d "/void-packages/hostdir/binpkgs" ]; then
                cp -r /void-packages/hostdir/binpkgs/* /artifacts/
            else
                echo "Build failed, no binaries found."
                exit 1
            fi
            '

      - name: 3. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman
          path: artifacts/*.xbps
