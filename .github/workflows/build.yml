name: Titanium Forge v40.0 (Native Root)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: void-packages
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/5] SYSTEM PREP (NATIVE)"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ ÐŸÐ Ð¯ÐœÐž Ð’ ÐšÐžÐÐ¢Ð•Ð™ÐÐ•Ð 
            # ÐÐ°Ð¼ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½ binary-bootstrap, Ð¼Ñ‹ ÑÐ°Ð¼Ð¸ ÑÑ‚Ð°Ð²Ð¸Ð¼ gcc Ð¸ make
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel shadow

            git config --global --add safe.directory /void-packages
            cd /void-packages

            echo ">>> [2/5] REPO SYNC"
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git fetch origin && git reset --hard origin/master
            fi

            echo ">>> [3/5] CODE LOBOTOMY (Surgery)"
            # 1. Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð¾Ñ‚ Root
            sed -i "/\[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            # 2. Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ resolv.conf (Ð¼Ñ‹ Ð¸ Ñ‚Ð°Ðº Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ)
            sed -i "s|cp -f /etc/resolv.conf|true #|g" xbps-src
            # 3. Ð£Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð½Ð° ÑÐ¸Ð¼Ð»Ð¸Ð½ÐºÐ¸ ÐºÐ¾Ñ€Ð½Ñ
            grep -rIl "isn.t symlinked to" . | xargs sed -i "s/msg_error .*isn.t symlinked to.*/true/g" 2>/dev/null || true
            # 4. ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸
            echo "check_root() { return 0; }" > common/xbps-src/shutils/check_root.sh

            echo ">>> [4/5] CONFIGURING HASWELL"
            # Ð“Ð¾Ð²Ð¾Ñ€Ð¸Ð¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñƒ: "Ð¢Ð²Ð¾Ñ Ð±Ð°Ð·Ð° - ÑÑ‚Ð¾ Ð²ÑÑ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° (/)"
            echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
            echo "XBPS_MASTERDIR=/" >> etc/conf
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
            
            # Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ Ð¼ÐµÑ‚ÐºÐ¸, Ñ‡Ñ‚Ð¾ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð°
            touch /.xbps_chroot_init
            
            # ðŸ’Ž Ð¤Ð›ÐÐ“Ð˜
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            echo ">>> [5/5] FORGING PIXMAN (NATIVE COMPILE)"
            # -E: Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
            # -f: Ð¿ÐµÑ€ÐµÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ
            # -D: Ð½Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÑ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð¼Ñ‹ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð¸Ð»Ð¸ base-devel Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ)
            ./xbps-src -E -f -D pkg pixman

            echo ">>> EXPORTING..."
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-native
          path: artifacts/
