name: Titanium Forge v26.0 (Depot Provisioning)

on:
  workflow_dispatch:

jobs:
  prepare_env:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Setup
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. THE DEPOT FILLER (Only Bootstrap)
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            echo "--> [1/3] Fixing Mirrors & Base Tools..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -S -y || true
            xbps-install -y xbps ca-certificates
            xbps-install -Syu -y git bash curl tar

            cd /void-packages

            echo "--> [2/3] Syncing Repository..."
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            fi

            echo "--> [3/3] SURGICAL ROOT REMOVAL (Killing the check)..."
            # Мы находим блок проверки в файле xbps-src и просто его УДАЛЯЕМ.
            # Мы удаляем все строки с 1 по 100, где встречается проверка UID.
            # Это самый надежный способ: нет кода — нет ошибки.
            sed -i "/if \[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            
            # На всякий случай гасим и в библиотеках
            echo "check_root() { return 0; }" > common/xbps-src/shutils/check_root.sh

            echo "--> [STARTING DOWNLOAD] Binary Bootstrap..."
            # Теперь это просто "качалка". Она скачает ~70 пакетов в masterdir.
            # Ошибки про Root больше не будет, мы её стерли.
            ./xbps-src binary-bootstrap

            echo ">>> DEPOT IS FULL. ALL TOOLS DOWNLOADED. <<<"
            
            chown -R 1001:1001 /void-packages
            '

      - name: 3. Save Cache
        if: success()
        uses: actions/cache/save@v4
        with:
          path: void-packages
          key: titanium-depot-v26-${{ github.run_id }}
