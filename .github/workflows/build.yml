name: Titanium Forge v37.0 (Classic Force)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_cache
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_cache
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾ Ð·Ð°Ð½Ð¾Ð²Ð¾
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/4] SYSTEM PREP"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            # Ð”Ð¾ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ bash (Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð² ÐºÑÑˆÐµ)
            xbps-install -Syu -y xbps ca-certificates git bash curl tar

            # Fix Git
            git config --global --add safe.directory /void-packages
            cd /void-packages

            echo ">>> [2/4] REPO SYNC & CLEANUP"
            # Ð§Ð¸ÑÑ‚Ð¸Ð¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¼ÐµÑˆÐ°Ð»Ð¸
            rm -rf hostdir/binpkgs/*
            
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git fetch origin && git reset --hard origin/master
            fi

            echo ">>> [3/4] NUCLEAR LOBOTOMY (Root Check Removal)"
            # 1. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ð¼ Ñ„Ð°Ð¹Ð»Ðµ
            sed -i "/\[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            # 2. Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð² Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°Ñ…
            find common/xbps-src/shutils -name "*.sh" -exec sed -i "s/\[ \"\$(id -u)\" = \"0\" \]/false/g" {} +
            # 3. Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÐ¿ÐµÑ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ check_root
            echo "check_root() { return 0; }" >> common/xbps-src/shutils/common.sh
            
            # 4. ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ unshare (Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹)
            echo "check_unshare() { return 0; }" >> common/xbps-src/shutils/common.sh

            echo ">>> [4/4] CONFIGURING HASWELL"
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸, ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð¸
            rm -f etc/conf
            
            # ÐŸÐ¸ÑˆÐµÐ¼ Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ (Ð‘Ð•Ð— ETHEREAL, Ð‘Ð•Ð— MASTERDIR=/)
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
            # Ð—ÐÐŸÐ Ð•Ð©ÐÐ•Ðœ Ð¡ÐšÐÐ§ÐšÐ£ Ð‘Ð˜ÐÐÐ ÐÐ˜ÐšÐžÐ’ -> Ð¢ÐžÐ›Ð¬ÐšÐž Ð¡Ð‘ÐžÐ ÐšÐ
            echo "XBPS_SKIP_REMOTEREPOS=yes" >> etc/conf
            
            # ðŸ’Ž 13 Ð¢Ð˜Ð¢ÐÐÐžÐ’Ð«Ð¥ Ð¤Ð›ÐÐ“ÐžÐ’
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            echo "--> BOOTSTRAP (Creating separate masterdir)..."
            ./xbps-src binary-bootstrap

            echo "--> FORGING PIXMAN (REAL COMPILATION)..."
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±ÐµÐ· Ñ„Ð»Ð°Ð³Ð° -E. Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ°Ð¼ ÑÐ¾Ð·Ð´Ð°ÑÑ‚ chroot Ð² Ð¿Ð°Ð¿ÐºÐµ masterdir.
            ./xbps-src pkg pixman

            echo ">>> EXPORTING BINARIES"
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # Ð§Ð¸Ð½Ð¸Ð¼ Ð¿Ñ€Ð°Ð²Ð°
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages /var/cache/xbps
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-compiled
          path: artifacts/
