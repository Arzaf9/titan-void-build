name: Titanium Forge v41.0 (Source Enforcer)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: void-packages
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/5] NATIVE SYSTEM PREP"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –°—Ç–∞–≤–∏–º –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –ø—Ä—è–º–æ –≤ –î–æ–∫–µ—Ä
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel shadow

            git config --global --add safe.directory /void-packages
            cd /void-packages

            echo ">>> [2/5] REPO SYNC"
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git fetch origin && git reset --hard origin/master
            fi

            echo ">>> [3/5] NUCLEAR LOBOTOMY"
            # 1. –£–±–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ Root
            sed -i "/\[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            # 2. –£–±–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç resolv.conf
            sed -i "s|cp -f /etc/resolv.conf|true #|g" xbps-src
            # 3. –£–±–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∞—Å—Ç–µ—Ä–¥–∏—Ä–∞
            sed -i "s/msg_error .*isn.t symlinked to.*/true/g" common/xbps-src/shutils/chroot.sh 2>/dev/null || true
            # 4. –ó–∞–Ω—É–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏
            echo "check_root() { return 0; }" > common/xbps-src/shutils/check_root.sh

            echo ">>> [4/5] CONFIGURING HASWELL (FORCE SOURCE)"
            # –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ñ–∏–≥
            echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
            echo "XBPS_MASTERDIR=/" >> etc/conf
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
            
            # --- –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: –ò–ì–ù–û–†–ò–†–£–ï–ú –£–î–ê–õ–ï–ù–ù–´–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–ò ---
            echo "XBPS_SKIP_REMOTEREPOS=yes" >> etc/conf
            
            # üíé –¢–í–û–ò 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π –±—É—Ç—Å—Ç—Ä–∞–ø
            touch /.xbps_chroot_init

            echo ">>> [5/5] FORGING PIXMAN (GCC START)"
            # –£–±–∏—Ä–∞–µ–º -D, –¥–æ–±–∞–≤–ª—è–µ–º -f
            ./xbps-src -E -f pkg pixman

            echo ">>> EXPORTING BINARIES"
            # –ò—â–µ–º –ø–∞–∫–µ—Ç—ã –∏ –∫–æ–ø–∏—Ä—É–µ–º –∏—Ö –Ω–∞—Ä—É–∂—É
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # –î–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è GitHub
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-haswell
          path: artifacts/
