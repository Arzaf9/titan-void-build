name: Titanium Forge v12.0 (Single Thread Test)

on:
  workflow_dispatch:

jobs:
  test_build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Prepare & Build
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            # --- 1. –°–ò–°–¢–ï–ú–ê ---
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            # –û–±–Ω–æ–≤–ª—è–µ–º SSL –∏ –ø–∞–∫–µ—Ç—ã (–∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π Root)
            xbps-install -Syu -y xbps ca-certificates git bash base-devel binutils curl tar
            
            # --- 2. –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–ï ---
            git clone --depth 1 https://github.com/void-linux/void-packages.git /void-packages
            cd /void-packages
            
            # --- 3. –õ–û–ë–û–¢–û–ú–ò–Ø (–í–´–†–ï–ó–ê–ï–ú –ü–†–û–í–ï–†–ö–ò) ---
            # –ú—ã –Ω–µ –æ–±–º–∞–Ω—ã–≤–∞–µ–º id, –º—ã –º–µ–Ω—è–µ–º –∫–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞.
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –æ—à–∏–±–∫–æ–π –∏ –∑–∞–º–µ–Ω—è–µ–º –µ—ë –Ω–∞ –±–µ–∑–æ–±–∏–¥–Ω—É—é –∫–æ–º–∞–Ω–¥—É
            sed -i "s/msg_error \"xbps-src cannot be used as root.\"/echo \"Running as Root (Titanium Mode)\"/g" xbps-src
            # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –∏–Ω–∞—á–µ:
            sed -i "s/\[ \"\$(id -u)\" = \"0\" \]/false/g" xbps-src
            
            # –ü–∞—Ç—á–∏–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ shutils (–≤–µ–∑–¥–µ, –≥–¥–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ root)
            find common/xbps-src/shutils -name "*.sh" -exec sed -i "s/\[ \"\$(id -u)\" = \"0\" \]/false/g" {} +
            
            # --- 4. –ë–£–¢–°–¢–†–ê–ü ---
            ./xbps-src binary-bootstrap
            
            # --- 5. –ö–û–ù–§–ò–ì HASWELL ---
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
            echo "XBPS_CFLAGS=\"$FLAGS\"" > etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
            echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
            
            # --- 6. –¢–ï–°–¢–û–í–ê–Ø –°–ë–û–†–ö–ê (–¢–û–õ–¨–ö–û –ë–ê–ó–ê) ---
            # –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–±–µ—Ä–µ—Ç—Å—è, –∑–Ω–∞—á–∏—Ç –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
            for pkg in pixman cairo libX11 mesa; do
                echo "üî® FORGING: $pkg"
                ./xbps-src -E -f pkg $pkg
            done
            
            # --- 7. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï ---
            # –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ, —á—Ç–æ–±—ã –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            cp -r hostdir/binpkgs/* /artifacts/ || echo "No packages built"
            '

      - name: 2. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-test-build
          path: artifacts/
