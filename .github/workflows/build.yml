name: Titanium Forge v15.0 (Bootstrap Loader)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Create Build Script (Host Side)
        run: |
          # Этот скрипт будет запущен УЖЕ внутри Bash, когда мы его установим
          cat << 'EOF' > run_build.sh
          #!/bin/bash
          set -e
          
          echo ">>> [STEP 2] INSTALLING BUILD TOOLS..."
          # Bash уже есть, ставим остальное
          xbps-install -Syu -y base-devel sudo git curl tar
          
          echo ">>> [STEP 3] SETUP USER 'BUILDER'"
          useradd -m -s /bin/bash builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          mkdir -p /home/builder/void-packages
          chown builder:builder /home/builder/void-packages
          
          echo ">>> [STEP 4] SWITCHING TO USER MODE"
          # Передаем управление юзеру builder
          sudo -u builder -i bash << 'USER_EOF'
          set -e
          cd /home/builder/void-packages
          
          echo "   -> Cloning..."
          git clone --depth 1 https://github.com/void-linux/void-packages.git .
          
          echo "   -> Bootstrap..."
          ./xbps-src binary-bootstrap
          
          echo "   -> Configuring Haswell Flags..."
          FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
          
          echo "XBPS_CFLAGS=\"$FLAGS\"" > etc/conf
          echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
          echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
          echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
          
          echo "   -> COMPILING PIXMAN..."
          # -E (ethereal) обязательно для Docker
          ./xbps-src -E pkg pixman
          
          echo ">>> BUILD COMPLETE"
          USER_EOF
          
          echo ">>> [STEP 5] EXPORTING ARTIFACTS"
          cp -r /home/builder/void-packages/hostdir/binpkgs/* /artifacts/ 2>/dev/null || echo "Artifact copy failed/empty"
          EOF
          
          chmod +x run_build.sh
          mkdir -p artifacts

      - name: 2. Execute in Docker (Via SH -> BASH)
        run: |
          # ЗАПУСК ЧЕРЕЗ /bin/sh (так как bash еще нет)
          docker run --privileged --rm \
            -v ${{ github.workspace }}/run_build.sh:/run_build.sh \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            
            set -e
            echo ">>> [STEP 1] BOOTSTRAPPING CONTAINER..."
            
            # 1. Лечим зеркала
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # 2. Обновляем xbps и ставим Bash
            # Игнорируем ошибки первой синхронизации (SSL)
            xbps-install -S -y || true
            # Ставим ключи и bash
            xbps-install -y xbps ca-certificates bash
            
            # 3. Передаем управление в Bash-скрипт
            echo ">>> EXEC BASH SCRIPT"
            /bin/bash /run_build.sh
            '

      - name: 3. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman
          path: artifacts/*.xbps
