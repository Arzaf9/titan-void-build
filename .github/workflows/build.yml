name: Titanium Forge v31.0 (Nuclear Root Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: void-packages
          key: void-persistent-v31-${{ github.run_id }}
          restore-keys: |
            void-persistent-v30-
            void-persistent-

      - name: 3. THE TITANIUM BUILDER (ROOT FORCE)
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/4] SYSTEM SETUP"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            xbps-install -Syu -y xbps ca-certificates bash git curl tar base-devel

            cd /void-packages

            echo ">>> [2/4] REPOSITORY SYNC"
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              echo "Using cache. Updating..."
              git fetch origin
              git reset --hard origin/master
            fi

            echo ">>> [3/4] NUCLEAR LOBOTOMY (BYPASS ROOT CHECK)"
            # –ú—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ Root –∏–∑ —Ñ–∞–π–ª–∞ xbps-src
            # –£–¥–∞–ª—è–µ–º –±–ª–æ–∫: if [ "$(id -u)" = "0" ]; ... fi
            sed -i "/\[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            
            # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö
            find common/xbps-src/shutils -name "*.sh" -exec sed -i "s/id -u/echo 1000/g" {} +
            echo "check_root() { return 0; }" >> common/xbps-src/shutils/common.sh

            echo ">>> [4/4] CONFIGURING & BUILDING"
            # –ú–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            touch /.xbps_chroot_init

            # –ö–æ–Ω—Ñ–∏–≥ Haswell
            echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=\$(nproc)" >> etc/conf
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
            echo "XBPS_CFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            echo "--> Starting Binary Bootstrap..."
            ./xbps-src binary-bootstrap

            echo "--> BUILDING PIXMAN..."
            # -E (ethereal) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Å—Ä–µ–¥—É
            ./xbps-src -E pkg pixman

            echo ">>> EXPORTING..."
            cp -r hostdir/binpkgs/* /artifacts/ 2>/dev/null || echo "Build still in progress or no pkgs."
            
            # –ß–∏–Ω–∏–º –ø—Ä–∞–≤–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ GitHub
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-haswell
          path: artifacts/
