name: Void Forge (Final Boss Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: voidlinux/voidlinux-musl:latest
      options: --privileged

    steps:
      - name: 1. Prepare Environment (Root)
        run: |
          # 1. Сносим старые конфиги репозиториев
          rm -rf /etc/xbps.d/*
          
          # 2. Используем HTTP (без S), чтобы гарантированно обойти проблемы с сертификатами на старте
          echo "repository=http://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
          
          # 3. Обновляемся и ставим всё необходимое
          xbps-install -Syu -y xbps
          xbps-install -Syu -y ca-certificates git bash sudo base-devel tar curl

          # 4. Создаем пользователя, так как xbps-src запрещено запускать от root
          if ! id -u builder >/dev/null 2>&1; then
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          fi

      - name: 2. Setup and Build (Builder)
        run: |
          # Клонируем репо и меняем владельца
          git clone --depth=1 https://github.com/void-linux/void-packages.git /void-packages
          chown -R builder:builder /void-packages
          
          # Запускаем сборку от имени юзера
          su builder -c '
            cd /void-packages
            
            # Настройка: режим ethereal (сборка прямо в системе без контейнеров в контейнере)
            echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            
            # Твои Haswell оптимизации
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto"
            echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf

            # Собираем пакет
            ./xbps-src pkg pixman
          '

      - name: 3. Collect Artifacts
        if: always()
        run: |
          mkdir -p /artifacts
          if [ -d "/void-packages/hostdir/binpkgs" ]; then
            find /void-packages/hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
          fi

      - name: 4. Upload
        uses: actions/upload-artifact@v4
        with:
          name: void-pixman-haswell
          path: /artifacts/
