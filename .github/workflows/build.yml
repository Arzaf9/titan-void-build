name: Titanium Forge v43.0

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_pkg_cache
          # –î–∞–µ–º –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã Docker –∏ GitHub Runner –Ω–µ –¥—Ä–∞–ª–∏—Å—å
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Persistent Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_pkg_cache
          key: titanium-v43-${{ github.run_id }}
          restore-keys: |
            titanium-v43-
            titanium-v42-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_pkg_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            
            # –ú—ã –ù–ï —Å—Ç–∞–≤–∏–º set -e —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏ –ø–∞—Ç—á–µ–π
            echo ">>> [1/5] SYSTEM REPAIR"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–∏–∑ –∫—ç—à–∞, –µ—Å–ª–∏ –µ—Å—Ç—å)
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel shadow
            
            set -e
            git config --global --add safe.directory /void-packages
            cd /void-packages

            echo ">>> [2/5] REPO SYNC"
            [ ! -d ".git" ] && git clone --depth 1 https://github.com/void-linux/void-packages.git .
            git fetch origin && git reset --hard origin/master

            echo ">>> [3/5] FUNCTION OVERRIDE (Lobotimizer)"
            # –ú—ã –Ω–µ –ø–∞—Ç—á–∏–º sed-–æ–º, –º—ã –ü–ï–†–ï–û–ü–†–ï–î–ï–õ–Ø–ï–ú —Ñ—É–Ω–∫—Ü–∏–∏
            # –î–æ–ø–∏—Å—ã–≤–∞–µ–º –≤ –∫–æ–Ω–µ—Ü common.sh –∑–∞–≥–ª—É—à–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–º–µ–Ω—è—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—ã
            cat << EOF_FUNC >> common/xbps-src/shutils/common.sh
            check_root() { return 0; }
            check_unshare() { return 0; }
            EOF_FUNC

            # –î–æ–ø–∏—Å—ã–≤–∞–µ–º –≤ chroot.sh, —á—Ç–æ–±—ã —É–±–∏—Ç—å –æ—à–∏–±–∫–∏ resolv.conf –∏ symlink
            cat << EOF_CHROOT >> common/xbps-src/shutils/chroot.sh
            setup_chroot() { return 0; }
            chroot_handler() { shift; eval "\$@"; }
            EOF_CHROOT

            echo ">>> [4/5] CONFIGURING HASWELL"
            # –ß–∏—Å—Ç—ã–π –∫–æ–Ω—Ñ–∏–≥
            cat << CONF_EOF > etc/conf
            XBPS_CHROOT_CMD=ethereal
            XBPS_MASTERDIR=/
            XBPS_ALLOW_CHROOT_BREAKOUT=yes
            XBPS_ALLOW_RESTRICTED=yes
            XBPS_SKIP_REMOTEREPOS=yes
            XBPS_MAKEJOBS=\$(nproc)
            CONF_EOF
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            # –ü–∞—Å–ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º—ã
            touch /.xbps_chroot_init

            echo ">>> [5/5] FORGING PIXMAN (GCC START)"
            # –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫ –æ–±—è–∑–∞–Ω –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫ –ø—Ä–∞–≤ –∏ –ø—É—Ç–µ–π
            ./xbps-src -E -f pkg pixman

            echo ">>> EXPORTING BINARIES"
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ —é–∑–µ—Ä—É –≥–∏—Ç—Ö–∞–±–∞ (1001), —á—Ç–æ–±—ã –∫—ç—à —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages /var/cache/xbps
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-haswell
          path: artifacts/
