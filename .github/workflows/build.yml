name: Titanium Forge v28.0 (Single Session User Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Setup
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          # Даем права всем, чтобы хост и контейнер не ругались
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        id: cache-void
        uses: actions/cache@v4
        with:
          path: void-packages
          key: void-persistent-v28-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            void-persistent-v28-${{ runner.os }}-

      - name: 3. THE TITANIUM BUILDER (Root Setup -> User Build)
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/4] ROOT: PREPARING ENVIRONMENT"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # Ставим bash и инструменты управления юзерами
            xbps-install -Syu -y xbps ca-certificates bash shadow git curl tar base-devel

            # Создаем обычного пользователя titan (UID 1000)
            if ! id -u titan >/dev/null 2>&1; then
              useradd -m titan
            fi

            # Отдаем папку пользователю
            chown -R titan:titan /void-packages

            echo ">>> [2/4] SWITCHING TO USER: titan"
            # Переходим в bash от имени юзера titan
            su titan -c "bash << 'USER_EOF'
              set -e
              cd /void-packages

              echo '>>> [3/4] SYNCING REPOSITORY'
              if [ ! -d '.git' ]; then
                git clone --depth 1 https://github.com/void-linux/void-packages.git .
              else
                git fetch origin
                git reset --hard origin/master
              fi

              echo '>>> [4/4] STARTING BINARY BOOTSTRAP (THE DEPOT)'
              # Теперь xbps-src работает от обычного юзера. Никаких проверок на root!
              ./xbps-src binary-bootstrap
              
              echo '>>> SUCCESS! ENVIRONMENT IS READY. <<<'
            USER_EOF"

            # Возвращаем права хосту для сохранения кэша
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: void-packages
          key: void-persistent-v28-${{ runner.os }}-${{ github.run_id }}
