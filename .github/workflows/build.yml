name: Titanium Forge v30.0 (Sudo User Mode)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Cleanup
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        uses: actions/cache@v4
        with:
          path: void-packages
          key: void-persistent-v30-${{ github.run_id }}
          restore-keys: |
            void-persistent-v28-
            void-persistent-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/3] ROOT: SYSTEM PREP"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑—ã + sudo (–æ–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω!)
            xbps-install -Syu -y xbps ca-certificates bash shadow git curl tar base-devel sudo

            # –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ titan –∏ –¥–∞–µ–º –µ–º—É –ø—Ä–∞–≤–∞ –±–æ–≥–∞ (sudo)
            id -u titan >/dev/null 2>&1 || useradd -m titan
            echo "titan ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –ø–∞–ø–∫—É
            chown -R titan:titan /void-packages

            # --- –ü–ò–®–ï–ú –°–ö–†–ò–ü–¢ –°–ë–û–†–ö–ò ---
            cat << "EOF_FORGE" > /home/titan/forge.sh
            set -e
            cd /void-packages

            echo ">>> [2/3] REPO SYNC"
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              echo "Using cache. Syncing..."
              git fetch origin
              git reset --hard origin/master
            fi

            echo ">>> [3/3] CONFIGURING ETHEREAL & HASWELL"
            # –°—Ä–∞–∑—É –≤–∫–ª—é—á–∞–µ–º ethereal, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ uid_map
            echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=\$(nproc)" >> etc/conf
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
            echo "XBPS_CFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"\$FLAGS\"" >> etc/conf

            echo ">>> STARTING BINARY BOOTSTRAP"
            # –¢–µ–ø–µ—Ä—å –±—É—Ç—Å—Ç—Ä–∞–ø –ø—Ä–æ–π–¥–µ—Ç —á–µ—Ä–µ–∑ sudo –≤ —Å–∏—Å—Ç–µ–º—É –î–æ–∫–µ—Ä–∞
            ./xbps-src binary-bootstrap

            echo ">>> FORGING PIXMAN"
            ./xbps-src -f pkg pixman

            echo ">>> EXPORTING..."
            cp -r hostdir/binpkgs/* /artifacts/ 2>/dev/null || echo "No pkgs yet"
            EOF_FORGE

            # –ó–∞–ø—É—Å–∫ –æ—Ç —é–∑–µ—Ä–∞
            chmod +x /home/titan/forge.sh
            chown titan:titan /home/titan/forge.sh
            su titan -c "/bin/bash /home/titan/forge.sh"

            # –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∞–≤ –¥–ª—è –∫—ç—à–∞
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-package
          path: artifacts/
