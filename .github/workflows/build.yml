name: Titanium Forge v24.0 (Nuclear Root Fix)

on:
  workflow_dispatch:

jobs:
  prepare_env:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Setup
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Cache
        id: cache-void
        uses: actions/cache@v4
        with:
          path: void-packages
          key: titanium-cache-v24-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            titanium-cache-v24-${{ runner.os }}-

      - name: 3. THE NUCLEAR PROVISIONER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            echo "--> [1/4] Fixing Mirrors & Installing Tools..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -S -y || true
            xbps-install -y xbps ca-certificates
            xbps-install -Syu -y git bash curl tar

            cd /void-packages

            echo "--> [2/4] Repository Sync..."
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git fetch origin
              git reset --hard origin/master
            fi

            echo "--> [3/4] NUCLEAR LOBOTOMY (Removing Root Checks)..."
            # 1. Удаляем блок проверки в главном скрипте
            # Мы ищем строку с проверкой id -u и удаляем её и следующие 2 строки (блок if)
            sed -i "/\[ \"\$(id -u)\" = \"0\" \]/,+2d" xbps-src
            
            # 2. Удаляем упоминания ошибки во всем репозитории
            grep -rIl "cannot be used as root" . | xargs sed -i "s/die \"xbps-src cannot be used as root.\"/return 0/g" 2>/dev/null || true
            grep -rIl "cannot be used as root" . | xargs sed -i "s/msg_error \"xbps-src cannot be used as root.\"/return 0/g" 2>/dev/null || true
            
            # 3. Переписываем функцию check_root в библиотеках, чтобы она всегда возвращала успех
            find common/xbps-src/shutils -name "*.sh" -exec sed -i "s/id -u/echo 1000/g" {} +
            echo "check_root() { return 0; }" >> common/xbps-src/shutils/common.sh

            echo "--> [4/4] Binary Bootstrap (Now it MUST work)..."
            # Принудительно запускаем бутстрап
            ./xbps-src binary-bootstrap
            
            ./xbps-src fetch pixman

            echo ">>> PROVISIONING COMPLETE. ALL FILES IN CACHE. <<<"
            
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Save Provisioned State
        if: success()
        uses: actions/cache/save@v4
        with:
          path: void-packages
          key: titanium-cache-v24-${{ runner.os }}-${{ github.run_id }}
