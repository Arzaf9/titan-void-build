name: Titanium Forge v27.0 (Cache & Ghost Bypass)

on:
  workflow_dispatch:

jobs:
  prepare_and_forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Init Workspace
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Void-Packages Cache
        id: cache-repo
        uses: actions/cache@v4
        with:
          path: void-packages
          key: void-repo-v27-${{ runner.os }}

      - name: 3. FILL THE DEPOT (Tools & Repo)
        # Ð­Ñ‚Ð¾Ñ‚ ÑˆÐ°Ð³ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐºÑÑˆ Ð¿ÑƒÑÑ‚
        if: steps.cache-repo.outputs.cache-hit != 'true'
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            echo "--> Fixing Mirrors & Installing Tools..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -Syu -y xbps ca-certificates git bash curl tar

            echo "--> Cloning Void-Packages..."
            cd /void-packages
            git clone --depth 1 https://github.com/void-linux/void-packages.git .
            
            # Ð§Ð¸Ð½Ð¸Ð¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ ÐºÑÑˆÐ° Ñ…Ð¾ÑÑ‚Ð°
            chown -R 1001:1001 /void-packages
            '

      - name: 4. THE GHOST BYPASS (The Real Hack)
        # Ð­Ñ‚Ð¾Ñ‚ ÑˆÐ°Ð³ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð’Ð¡Ð•Ð“Ð”Ð, Ð¾Ð½ Ð¼Ð³Ð½Ð¾Ð²ÐµÐ½Ð½Ñ‹Ð¹
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            # ðŸŽ­ Ð¡ÐžÐ—Ð”ÐÐ•Ðœ ÐŸÐ Ð˜Ð—Ð ÐÐ§ÐÐžÐ• Ð£Ð”ÐžÐ¡Ð¢ÐžÐ’Ð•Ð Ð•ÐÐ˜Ð•
            # ÐœÑ‹ Ð¿Ð¾Ð´Ð¼ÐµÐ½ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ id. 
            # Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÐºÐ¾Ð³Ð´Ð° xbps-src ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ "id -u", Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ "1000" Ð²Ð¼ÐµÑÑ‚Ð¾ "0".
            echo "#!/bin/sh" > /usr/local/bin/id
            echo "echo 1000" >> /usr/local/bin/id
            chmod +x /usr/local/bin/id
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð»Ð¸ Ñ…Ð°Ðº
            export PATH="/usr/local/bin:$PATH"
            echo "Current Identity: UID=$(id -u)"

            echo "--> Starting Binary Bootstrap (Download Build Base)..."
            cd /void-packages
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· bash Ð¸ Ð¿Ñ€Ð¾ÐºÐ¸Ð´Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð°Ñˆ PATH Ñ Ñ„ÐµÐ¹ÐºÐ¾Ð²Ñ‹Ð¼ id
            /bin/bash -c "export PATH=/usr/local/bin:\$PATH; ./xbps-src binary-bootstrap"

            echo ">>> SUCCESS! DEPOT IS READY. <<<"
            chown -R 1001:1001 /void-packages
            '
