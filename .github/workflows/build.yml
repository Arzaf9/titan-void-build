name: Titanium Forge v16.0 (Root Force)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Artifacts
        run: mkdir -p artifacts

      - name: 2. Docker Root Build
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            echo ">>> [1] INSTALLING BASH & TOOLS..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -S -y || true
            xbps-install -y xbps ca-certificates
            xbps-install -Syu -y bash git curl tar base-devel
            
            # Переходим на Bash для надежности
            exec /bin/bash << "EOF_BASH"
            set -e
            
            echo ">>> [2] CLONING VOID-PACKAGES..."
            git clone --depth 1 https://github.com/void-linux/void-packages.git /void-packages
            cd /void-packages
            
            echo ">>> [3] APPLYING ROOT BYPASS PATCH..."
            # Самый важный шаг: Заменяем проверку UID в коде.
            # Вместо реального id -u скрипт будет видеть "echo 1000"
            # Это обманет [ $(id -u) -eq 0 ]
            
            # Патчим главный файл
            sed -i "s/id -u/echo 1000/g" xbps-src
            
            # Патчим библиотеки (где тоже могут быть проверки)
            find common/xbps-src/shutils -name "*.sh" -exec sed -i "s/id -u/echo 1000/g" {} +
            
            # Дополнительная страховка: убиваем функцию check_root
            echo "check_root() { return 0; }" >> common/xbps-src/shutils/common.sh
            
            echo ">>> [4] BOOTSTRAP (AS ROOT, BUT MASKED)..."
            # Запускаем бутстрап. Он подумает, что мы юзер 1000, но права у нас будут рутовые.
            ./xbps-src binary-bootstrap
            
            echo ">>> [5] CONFIGURING HASWELL..."
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
            
            echo "XBPS_CFLAGS=\"$FLAGS\"" > etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf
            # Ethereal режим обязателен для работы от рута без unshare
            echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
            
            echo ">>> [6] BUILDING PIXMAN..."
            # -E (ethereal) + -f (force)
            ./xbps-src -E -f pkg pixman
            
            echo ">>> [7] EXPORTING..."
            if [ -d "hostdir/binpkgs" ]; then
                cp -r hostdir/binpkgs/* /artifacts/
                echo "Export success."
            else
                echo "Error: No binaries found."
                exit 1
            fi
            EOF_BASH
            '

      - name: 3. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman
          path: artifacts/*.xbps
