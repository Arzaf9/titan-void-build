name: Titanium Forge v35.0 (Force Compile)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_cache
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Persistent Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_cache
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÐºÐ»ÑŽÑ‡, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾
          key: titanium-v33-${{ github.run_id }}
          restore-keys: titanium-v33-

      - name: 3. THE TITANIUM BUILDER
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e

            echo ">>> [1/5] SYSTEM RECOVERY"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -Syu -y xbps ca-certificates git bash curl tar

            # Ð¤Ð¸ÐºÑ Git
            git config --global --add safe.directory /void-packages
            cd /void-packages

            echo ">>> [2/5] CLEANUP & PREP"
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿ÑƒÑ‚Ð°Ñ‚ÑŒÑÑ
            rm -rf hostdir/binpkgs/*
            
            # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ
            [ ! -d ".git" ] && git clone --depth 1 https://github.com/void-linux/void-packages.git .
            
            # Root Patch
            sed -i "s/\[ \"\$(id -u)\" = \"0\" \]/false/g" xbps-src
            echo "check_root() { return 0; }" > common/xbps-src/shutils/check_root.sh

            echo ">>> [3/5] REVISION HACK (Tricking the Builder)"
            # ÐœÐ« ÐœÐ•ÐÐ¯Ð•Ðœ Ð’Ð•Ð Ð¡Ð˜Ð® ÐŸÐÐšÐ•Ð¢Ð Ð›ÐžÐšÐÐ›Ð¬ÐÐž
            # Ð­Ñ‚Ð¾ Ð·Ð°ÑÑ‚Ð°Ð²Ð¸Ñ‚ xbps-src Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ, Ð¸ Ð¾Ð½ ÐžÐ‘Ð¯Ð—ÐÐ ÐµÑ‘ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ.
            sed -i "s/revision=.*/revision=99/" srcpkgs/pixman/template
            echo "Pixman template revision bumped to 99!"

            echo ">>> [4/5] CONFIGURING HASWELL"
            echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
            echo "XBPS_MASTERDIR=/" >> etc/conf
            echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
            echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
            echo "XBPS_MAKEJOBS=\$(nproc)" >> etc/conf
            
            # ðŸ’Ž 13 Ð¤Ð›ÐÐ“ÐžÐ’
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"\$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            touch /.xbps_chroot_init

            echo "--> PRE-FLIGHT (Bootstrap)..."
            ./xbps-src binary-bootstrap

            echo "--> FORGING PIXMAN (COMPILATION START)..."
            # Ð¢ÐµÐ¿ÐµÑ€ÑŒ, ÐºÐ¾Ð³Ð´Ð° Ð²ÐµÑ€ÑÐ¸Ñ = 99, Ð¾Ð½ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð½Ð°Ñ‡Ð½ÐµÑ‚ ÑÐ±Ð¾Ñ€ÐºÑƒ
            ./xbps-src -E pkg pixman

            echo ">>> [5/5] EXPORTING BINARIES"
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages /var/cache/xbps
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-pixman-custom
          path: artifacts/
