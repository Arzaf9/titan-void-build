name: Titanium Forge v22.0 (Provisioning & Cache)

on:
  workflow_dispatch:

jobs:
  prepare_env:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Clean & Create Workspace
        run: |
          sudo mkdir -p void-packages artifacts
          sudo chmod -R 777 void-packages artifacts

      - name: 2. Restore Cache (if exists)
        uses: actions/cache/restore@v4
        with:
          path: void-packages
          key: titanium-bolt-v22-${{ github.run_id }}
          restore-keys: |
            titanium-bolt-v22-

      - name: 3. THE PROVISIONING SCRIPT
        run: |
          # Запускаем докер для подготовки
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            voidlinux/voidlinux-musl /bin/sh -c '
            set -e
            
            echo "--> [1/3] Fixing mirrors and installing system tools..."
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            xbps-install -Syu -y xbps ca-certificates git bash curl tar

            cd /void-packages
            
            echo "--> [2/3] Cloning or Syncing Repository..."
            if [ ! -d ".git" ]; then
              git clone --depth 1 https://github.com/void-linux/void-packages.git .
            else
              git fetch origin
              git reset --hard origin/master
            fi

            echo "--> [3/3] Bypassing Root & Running Bootstrap..."
            # Патчим xbps-src, чтобы он разрешал root (в докере это безопасно)
            sed -i "s/id -u/echo 1001/g" xbps-src
            find common/xbps-src/shutils -type f -name "*.sh" -exec sed -i "s/id -u/echo 1001/g" {} +
            
            # Запускаем бутстрап (скачивание базовой системы Void в masterdir)
            ./xbps-src binary-bootstrap

            # Предварительно скачиваем исходники для pixman, чтобы они тоже были в кэше
            ./xbps-src fetch pixman

            echo ">>> ENVIRONMENT READY AND PROVISIONED <<<"
            
            # Чиним права для GitHub Cache
            chown -R 1001:1001 /void-packages
            '

      - name: 4. Save Provisioned Environment to Cache
        uses: actions/cache/save@v4
        with:
          path: void-packages
          key: titanium-bolt-v22-${{ github.run_id }}
