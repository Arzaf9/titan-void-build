name: Titanium Forge v20.0 (Ultimate Fix)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Init Workspace
        run: |
          sudo mkdir -p artifacts void-packages
          # –î–∞–µ–º –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞, —á—Ç–æ–±—ã Docker –Ω–µ —Å–ø–æ—Ç—ã–∫–∞–ª—Å—è –≤ –Ω–∞—á–∞–ª–µ
          sudo chmod -R 777 void-packages artifacts

      - name: 2. Restore Persistent Cache
        uses: actions/cache@v4
        with:
          path: void-packages
          key: titanium-v20-${{ github.run_id }}
          restore-keys: |
            titanium-v20-

      - name: 3. THE MASTER SCRIPT
        run: |
          cat << 'EOF' > run_build.sh
          #!/bin/bash
          set -e

          echo ">>> [1/5] PREPARING SYSTEM (ROOT)..."
          mkdir -p /etc/xbps.d
          echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º–∏–Ω–∏–º—É–º–∞
          xbps-install -Sy || true
          xbps-install -y xbps ca-certificates
          xbps-install -Syu -y bash sudo git curl tar base-devel shadow

          # –°–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ builder
          if ! id -u builder >/dev/null 2>&1; then
            useradd -m -s /bin/bash builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          fi

          # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –ú–û–ù–¢–ò–†–û–í–ê–ù–ò–Ø (–ö–†–ò–¢–ò–ß–ù–û)
          chown -R builder:builder /home/builder/void-packages
          chmod -R 755 /home/builder/void-packages

          # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          sudo -u builder -i bash << 'USER_EOF'
          set -e
          cd ~/void-packages
          if [ ! -d ".git" ]; then
            echo "--> Folder empty, cloning..."
            git clone --depth 1 https://github.com/void-linux/void-packages.git .
          else
            echo "--> Existing repo found, cleaning..."
            git reset --hard
            git pull
          fi
          USER_EOF

          echo ">>> [2/5] INITIALIZING ETHEREAL MASTERDIR..."
          # –ß—Ç–æ–±—ã xbps-src –Ω–µ —Ä—É–≥–∞–ª—Å—è –≤ ethereal —Ä–µ–∂–∏–º–µ
          xbps-install -y base-chroot
          touch /.xbps_chroot_init

          echo ">>> [3/5] STARTING COMPILATION..."
          sudo -u builder -i bash << 'USER_EOF'
          set -e
          cd ~/void-packages

          # –ö–æ–Ω—Ñ–∏–≥ Haswell
          echo "XBPS_CHROOT_CMD=ethereal" > etc/conf
          echo "XBPS_MASTERDIR=/" >> etc/conf
          echo "XBPS_ALLOW_CHROOT_BREAKOUT=yes" >> etc/conf
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          echo "XBPS_MAKEJOBS=$(nproc)" >> etc/conf

          # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
          FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -Wl,--hash-style=gnu -pipe"
          echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
          echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
          echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

          echo "   -> FORGING PIXMAN..."
          ./xbps-src -E -f pkg pixman
          USER_EOF

          echo ">>> [4/5] EXPORTING BINARIES..."
          mkdir -p /artifacts
          cp -v /home/builder/void-packages/hostdir/binpkgs/*.xbps /artifacts/ || echo "No packages found."

          # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∞–≤–∞ –≤–ª–∞–¥–µ–ª—å—Ü—É —Ö–æ—Å—Ç–∞ (UID 1001), —á—Ç–æ–±—ã Cache —Å–º–æ–≥ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è
          chown -R 1001:1001 /home/builder/void-packages
          EOF
          chmod +x run_build.sh

      - name: 4. Run Docker
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/run_build.sh:/run_build.sh \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/void-packages:/home/builder/void-packages \
            voidlinux/voidlinux-musl /bin/sh /run_build.sh

      - name: 5. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-haswell-packages
          path: artifacts/
