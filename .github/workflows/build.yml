name: Titanium Forge v43.1 (Verbose Debug)

on:
  workflow_dispatch:

jobs:
  forge:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Workspace Init
        run: |
          mkdir -p ${{ github.workspace }}/void-packages
          mkdir -p ${{ github.workspace }}/artifacts
          mkdir -p ${{ github.workspace }}/xbps_pkg_cache
          sudo chmod -R 777 ${{ github.workspace }}

      - name: 2. Restore Persistent Cache
        uses: actions/cache@v4
        with:
          path: |
            void-packages
            xbps_pkg_cache
          key: titanium-v43-${{ github.run_id }}
          restore-keys: titanium-v43-

      - name: 3. THE TITANIUM BUILDER (VERBOSE)
        run: |
          docker run --privileged --rm \
            -v ${{ github.workspace }}/void-packages:/void-packages \
            -v ${{ github.workspace }}/artifacts:/artifacts \
            -v ${{ github.workspace }}/xbps_pkg_cache:/var/cache/xbps \
            voidlinux/voidlinux-musl /bin/sh -c '
            
            echo ">>> [1/5] REPAIRING SYSTEM"
            mkdir -p /etc/xbps.d
            echo "repository=https://repo-default.voidlinux.org/current/musl" > /etc/xbps.d/00-repository-main.conf
            
            # –°—Ç–∞–≤–∏–º –±–∞–∑—É
            xbps-install -Syu -y xbps ca-certificates git bash curl tar base-devel shadow || echo "System update had warnings"

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–ø–æ
            git config --global --add safe.directory /void-packages
            cd /void-packages || exit 1

            echo ">>> [2/5] REPO CHECK"
            if [ ! -d ".git" ]; then
              echo "Cloning repo..."
              git clone --depth 1 https://github.com/void-linux/void-packages.git . || exit 1
            fi
            git fetch origin && git reset --hard origin/master

            echo ">>> [3/5] LOBOTOMY & OVERRIDE"
            
            # –ò—â–µ–º, –≥–¥–µ —Ä–µ–∞–ª—å–Ω–æ –ª–µ–∂–∞—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            SHUTILS_DIR=$(find . -type d -name shutils | head -n 1)
            echo "Shutils directory found at: $SHUTILS_DIR"
            
            if [ -z "$SHUTILS_DIR" ]; then
                echo "CRITICAL ERROR: Shutils not found!"
                ls -R
                exit 1
            fi

            # üé≠ –ì–õ–ê–í–ù–´–ô –í–ó–õ–û–ú: –ü–æ–¥–º–µ–Ω—è–µ–º ID —Å–∏—Å—Ç–µ–º—ã
            # –≠—Ç–æ –æ–±–º–∞–Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É check_root –±–µ–∑ –ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
            mv /usr/bin/id /usr/bin/id_real
            echo "#!/bin/sh" > /usr/bin/id
            echo "if [ \"\$1\" = \"-u\" ]; then echo 1001; else /usr/bin/id_real \"\$@\"; fi" >> /usr/bin/id
            chmod +x /usr/bin/id
            echo "Identity check: UID is $(id -u) (Should be 1001)"

            # –û—Ç–∫–ª—é—á–∞–µ–º unshare (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            ln -sf /bin/true /usr/bin/unshare

            # üíâ –ü–†–Ø–ú–ê–Ø –ò–ù–™–ï–ö–¶–ò–Ø –í –ë–ò–ë–õ–ò–û–¢–ï–ö–ò (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
            echo "Patching common.sh..."
            [ -f "$SHUTILS_DIR/common.sh" ] && echo "check_root() { return 0; }" >> "$SHUTILS_DIR/common.sh"
            
            echo "Patching chroot.sh..."
            if [ -f "$SHUTILS_DIR/chroot.sh" ]; then
                echo "chroot_handler() { shift; eval \"\$@\"; }" >> "$SHUTILS_DIR/chroot.sh"
            fi

            echo ">>> [4/5] CONFIGURING HASWELL"
            cat << CONF_EOF > etc/conf
            XBPS_CHROOT_CMD=ethereal
            XBPS_MASTERDIR=/
            XBPS_ALLOW_CHROOT_BREAKOUT=yes
            XBPS_ALLOW_RESTRICTED=yes
            XBPS_SKIP_REMOTEREPOS=yes
            XBPS_MAKEJOBS=\$(nproc)
            CONF_EOF
            
            # üíé 13 –¢–ò–¢–ê–ù–û–í–´–• –§–õ–ê–ì–û–í
            FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto -fno-plt -fno-semantic-interposition -mprefer-vector-width=256 -ftree-vectorize -funroll-loops -floop-nest-optimize -fipa-pta -fdevirtualize-at-ltrans -pipe"
            echo "XBPS_CFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_CXXFLAGS=\"$FLAGS\"" >> etc/conf
            echo "XBPS_LDFLAGS=\"-Wl,-O1 -Wl,--as-needed -flto=auto\"" >> etc/conf

            # –ü–∞—Å–ø–æ—Ä—Ç —Å–∏—Å—Ç–µ–º—ã
            touch /.xbps_chroot_init
            mkdir -p masterdir
            touch masterdir/.xbps_chroot_init

            echo ">>> [5/5] FORGING PIXMAN"
            # –ó–∞–ø—É—Å–∫–∞–µ–º bash –¥–ª—è —Å–±–æ—Ä–∫–∏
            /bin/bash ./xbps-src -E -f pkg pixman 2>&1 | tee /tmp/build_log.txt

            echo ">>> EXPORTING BINARIES"
            find hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;
            
            # –ï—Å–ª–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∂–µ–º –ø–æ—á–µ–º—É
            if [ ! "$(ls -A /artifacts)" ]; then
                echo "Build failed. Last 50 lines of log:"
                tail -n 50 /tmp/build_log.txt
            fi

            chmod -R 777 /artifacts
            chown -R 1001:1001 /void-packages /var/cache/xbps
            '

      - name: 4. Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: titanium-debug-log
          path: artifacts/
