name: Void Forge (Ethereal Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Запускаем всё прямо внутри образа Void Linux
    container:
      image: voidlinux/voidlinux-musl:latest
      options: --privileged

    steps:
      - name: 1. System Prep
        run: |
          # Обновляем систему и ставим базовые инструменты сборки
          xbps-install -Syu -y xbps
          xbps-install -Syu -y git bash curl tar base-devel
          # Нам не нужен sudo, мы и так root внутри контейнера

      - name: 2. Clone void-packages
        run: |
          git clone --depth=1 https://github.com/void-linux/void-packages.git /void-packages

      - name: 3. Configure xbps-src (Ethereal)
        run: |
          cd /void-packages
          # ВКЛЮЧАЕМ РЕЖИМ ETHEREAL
          # Это заставляет xbps-src собирать пакеты прямо в текущей системе 
          # без использования chroot/bwrap/namespaces
          echo "XBPS_CHROOT_CMD=ethereal" >> etc/conf
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          
          # Твои Haswell оптимизации
          FLAGS="-O3 -march=haswell -mtune=haswell -flto=auto"
          echo "XBPS_CFLAGS='$FLAGS'" >> etc/conf
          echo "XBPS_CXXFLAGS='$FLAGS'" >> etc/conf
          
          # В режиме ethereal бинарный бутстрап не нужен так, как в обычном,
          # но зависимости для сборки подтянутся сами.

      - name: 4. Build Package
        run: |
          cd /void-packages
          # Собираем пакет. В режиме ethereal он установит сборочные зависимости прямо в контейнер.
          ./xbps-src pkg pixman

      - name: 5. Collect Artifacts
        if: always()
        run: |
          mkdir -p /artifacts
          find /void-packages/hostdir/binpkgs -name "*.xbps" -exec cp -v {} /artifacts/ \;

      - name: 6. Upload
        uses: actions/upload-artifact@v4
        with:
          name: pixman-haswell-musl
          path: /artifacts/
